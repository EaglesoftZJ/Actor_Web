{"version":3,"sources":["../../src/stores/ComposeStore.js"],"names":["ComposeStore","getInitialState","text","mentions","commands","autoFocus","editMessage","reduce","state","action","type","COMPOSE_CLEAN","BIND_DIALOG_PEER","COMPOSE_TYPING","nextState","peer","GROUP","query","caretPosition","findMentions","id","members","getState","results","from","where","data","peerInfo","userName","indexOf","title","isAdmin","select","toArray","command","findBotCommands","name","MESSAGES_EDIT_START","message","content","MESSAGES_EDIT_END","COMPOSE_MENTION_INSERT","console","error","mentionEnding","atStart","textBeforeMention","substring","length","textAfterMention","mention","mentionText","COMPOSE_MENTION_CLOSE","DRAFT_LOAD","draft","EMOJI_INSERT","textBeforeEmoji","textAfterEmoji","emoji","COMPOSE_PASTE","COMPOSE_TOGGLE_AUTO_FOCUS","isEnable","SEARCH_TOGGLE_FOCUS"],"mappings":"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","file":"ComposeStore.js","sourcesContent":["/*\n * Copyright (C) 2015 Actor LLC. <https://actor.im>\n */\n\nimport { ReduceStore } from 'flux/utils';\nimport Dispatcher from '../dispatcher/ActorAppDispatcher';\nimport { ActionTypes, PeerTypes } from '../constants/ActorAppConstants';\nimport ActorClient from '../utils/ActorClient';\nimport { parseMentionQuery, parseBotCommand } from '../utils/ComposeUtils';\nimport DialogInfoStore from '../stores/DialogInfoStore';\nimport linq from 'linq';\nclass ComposeStore extends ReduceStore {\n  getInitialState() {\n    return {\n      text: '',\n      mentions: null,\n      commands: null,\n      autoFocus: true,\n      editMessage: null\n    };\n  }\n\n  reduce(state, action) {\n    switch (action.type) {\n      case ActionTypes.COMPOSE_CLEAN:\n      case ActionTypes.BIND_DIALOG_PEER:\n        return this.getInitialState();\n\n      case ActionTypes.COMPOSE_TYPING:\n        const nextState = {\n          ...state,\n          text: action.text,\n          commands: null,\n          mentions: null\n        };\n\n        if (action.peer.type === PeerTypes.GROUP) {\n          const query = parseMentionQuery(action.text, action.caretPosition);\n          if (query) {\n            nextState.mentions = ActorClient.findMentions(action.peer.id, query.text);\n            var members = DialogInfoStore.getState().members;\n            // 数据源修改\n            var results = linq.from(members).where((data) => {\n              if((data.peerInfo.userName.indexOf(query.text) !== -1 || data.peerInfo.title.indexOf(query.text) !== -1) && !data.isAdmin) {\n                return true;\n              }\n              return false;\n            }).select(`{isAdmin: $.isAdmin, isNick: true, mentionMatches: [], mentionText: \"@\" + $.peerInfo.userName, secondMatches: [], secondText: $.peerInfo.title, peer:$.peerInfo }`).toArray();\n            nextState.mentions = results;\n          }\n        } else {\n          const command = parseBotCommand(action.text);\n          if (command) {\n            nextState.commands = ActorClient.findBotCommands(action.peer.id, command.name || '');\n          }\n        }\n\n        return nextState;\n\n      case ActionTypes.MESSAGES_EDIT_START:\n        return {\n          ...state,\n          text: action.message.content.text,\n          editMessage: action.message\n        };\n\n      case ActionTypes.MESSAGES_EDIT_END:\n        return {\n          ...state,\n          text: '',\n          editMessage: null\n        };\n\n      case ActionTypes.COMPOSE_MENTION_INSERT:\n        const query = parseMentionQuery(action.text, action.caretPosition);\n        if (!query) {\n          console.error('Mention not found', { state, action });\n          return state;\n        }\n\n        const mentionEnding = query.atStart ? ': ' : ' ';\n        const textBeforeMention = action.text.substring(0, action.caretPosition - query.text.length - 1);\n        const textAfterMention = action.text.substring(action.caretPosition, action.text.length);\n\n        return {\n          ...state,\n          text: textBeforeMention + action.mention.mentionText + mentionEnding + textAfterMention,\n          mentions: null\n        };\n\n      case ActionTypes.COMPOSE_MENTION_CLOSE:\n        return {\n          ...state,\n          mentions: null\n        };\n\n      case ActionTypes.DRAFT_LOAD:\n        return {\n          ...state,\n          text: action.draft\n        };\n\n      case ActionTypes.EMOJI_INSERT:\n        const textBeforeEmoji = action.text.substring(0, action.caretPosition);\n        const textAfterEmoji = action.text.substring(action.caretPosition, action.text.length);\n\n        return {\n          ...state,\n          text: textBeforeEmoji + action.emoji + ' ' + textAfterEmoji\n        };\n\n      case ActionTypes.COMPOSE_PASTE:\n        return {\n          ...state,\n          text: action.text\n        };\n\n      case ActionTypes.COMPOSE_TOGGLE_AUTO_FOCUS:\n        return {\n          ...state,\n          autoFocus: action.isEnable\n        };\n\n      case ActionTypes.SEARCH_TOGGLE_FOCUS:\n        return {\n          ...state,\n          autoFocus: !action.isEnable\n        };\n\n      default:\n        return state;\n    }\n  }\n}\n\nexport default new ComposeStore(Dispatcher);\n"]}