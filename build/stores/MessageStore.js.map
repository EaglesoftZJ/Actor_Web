{"version":3,"sources":["../../src/stores/MessageStore.js"],"names":["MESSAGE_COUNT_STEP","getMessageId","message","rid","MessageStore","getInitialState","messages","chatMessages","historyMessages","historyQueryData","dateRange","Date","getTime","filter","historyLoaded","overlay","isLoaded","receiveDate","readDate","readByMeDate","count","firstId","lastId","unreadId","editId","changeReason","UNKNOWN","selected","Set","isAllRendered","getState","length","reduce","state","action","type","BIND_DIALOG_PEER","HISTROY_MESSAGES_CHANGED","MESSAGES_CHANGED","revertMessage","from","where","toArray","i","item","JSON","parse","content","text","msg","setTimeout","deleteMessage","getCurrentPeer","message1","slice","message2","message3","peer","dialogs","getDialogs","dialog","shorts","id","updateTime","sort","a","b","concat","setDialogs","isElectron","sendToElectron","currentMsg","nextState","Math","min","UNSHIFT","lengthDiff","PUSH","UPDATE","unreadIndex","getMyId","MESSAGES_LOAD_MORE","MESSAGES_TOGGLE_SELECTED","has","remove","add","MESSAGES_EDIT_START","MESSAGES_EDIT_END"],"mappings":";;;;;;AAIA;;;;AACA;;AACA;;;;AACA;;AACA;;;;AACA;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;;;;;;;+eAdA;;;;AAgBA,IAAMA,qBAAqB,EAA3B;;AAEA,IAAMC,eAAe,SAAfA,YAAe,CAACC,OAAD;AAAA,SAAaA,UAAUA,QAAQC,GAAlB,GAAwB,IAArC;AAAA,CAArB;;IAEMC,Y;;;;;;;;;yBACJC,e,8BAAkB;AAChB,WAAO;AACLC,gBAAU,EADL,EACS;AACdC,oBAAc,EAFT,EAEa;AAClBC,uBAAiB,EAHZ,EAGgB;AACrBC,wBAAkB;AAChBC,mBAAW,CAAC,IAAIC,IAAJ,GAAWC,OAAX,EAAD,EAAuB,IAAID,IAAJ,GAAWC,OAAX,EAAvB,CADK;AAEhBC,gBAAQ;AAFQ,OAJb,EAOF;AACHC,qBAAe,IARV,EAQgB;AACrBC,eAAS,EATJ;AAULC,gBAAU,KAVL;AAWLC,mBAAa,CAXR;AAYLC,gBAAU,CAZL;AAaLC,oBAAc,CAbT;AAcLC,aAAO,CAdF;AAeLC,eAAS,IAfJ;AAgBLC,cAAQ,IAhBH;AAiBLC,gBAAU,IAjBL;AAkBLC,cAAQ,IAlBH;AAmBLC,oBAAc,uCAAoBC,OAnB7B;AAoBLC,gBAAU,IAAI,oBAAUC,GAAd;AApBL,KAAP;AAsBD,G;;yBAEDC,a,4BAAgB;AAAA,oBACc,KAAKC,QAAL,EADd;AAAA,QACNxB,QADM,aACNA,QADM;AAAA,QACIc,KADJ,aACIA,KADJ;;AAEd,WAAOd,SAASyB,MAAT,KAAoBX,KAA3B;AACD,G;;yBAEDY,M,mBAAQC,K,EAAOC,M,EAAQ;AACrB,YAAQA,OAAOC,IAAf;AACE,WAAK,+BAAYC,gBAAjB;AACE,eAAO,KAAK/B,eAAL,EAAP;;AAGF,WAAK,+BAAYgC,wBAAjB;AACE,4BACKJ,KADL;AAEEzB,2BAAiB0B,OAAO1B;AAF1B;AAIF,WAAK,+BAAY8B,gBAAjB;AACE;AACA,YAAIpC,UAAU,IAAd;AACA,YAAIqC,gBAAgB,eAAKC,IAAL,CAAUN,OAAO5B,QAAjB,EAA2BmC,KAA3B,CAAiC,wEAAjC,EAA2GC,OAA3G,EAApB;AACA;AACA,aAAK,IAAIC,IAAI,CAAb,EAAgBA,IAAIJ,cAAcR,MAAlC,EAA0CY,GAA1C,EAA+C;AAC7CzC,oBAAU,eAAKsC,IAAL,CAAUN,OAAO5B,QAAjB,EAA2BmC,KAA3B,CAAiC,UAACG,IAAD,EAAU;AACnD,mBAAOA,KAAKzC,GAAL,KAAa0C,KAAKC,KAAL,CAAWP,cAAcI,CAAd,EAAiBI,OAAjB,CAAyBC,IAApC,EAA0C7C,GAA9D;AACD,WAFS,EAEPuC,OAFO,GAEG,CAFH,CAAV;AAGA,cAAIxC,OAAJ,EAAa;AACX,aAAC,UAAS+C,GAAT,EAAc;AACbC,yBAAW,YAAY;AACrB,gDAAsBC,aAAtB,CAAoC,sBAAYC,cAAZ,EAApC,EAAkEH,IAAI9C,GAAtE;AACD,eAFD,EAEG,CAFH;AAGD,aAJD,EAIGD,OAJH;AAKD;AACF;;AAED,YAAImD,WAAWpB,MAAM3B,QAAN,CAAegD,KAAf,CAAqB,CAAC,CAAtB,EAAyB,CAAzB,CAAf;AACA,YAAIC,WAAWrB,OAAO5B,QAAP,CAAgBgD,KAAhB,CAAsB,CAAC,CAAvB,EAA0B,CAA1B,CAAf;AACA,YAAIE,WAAWtB,OAAO5B,QAAP,CAAgBgD,KAAhB,CAAsB,CAAC,CAAvB,EAA0B,CAA1B,CAAf;AACA,YAAID,YAAYE,QAAZ,IAAwBA,SAASpD,GAAT,KAAiBkD,SAASlD,GAAlD,IAAyDqD,SAAST,OAAT,CAAiBA,OAAjB,KAA6B,SAA1F,EAAqG;AACnG;AACAG,qBAAW,YAAY;AACrB,gBAAIO,OAAO,sBAAYL,cAAZ,EAAX;AACA,gBAAIM,UAAU,sBAAYC,UAAZ,EAAd;AACA,iBAAK,IAAIhB,IAAI,CAAb,EAAgBA,IAAIe,QAAQ3B,MAA5B,EAAoCY,GAApC,EAAyC;AACvC,kBAAIiB,SAAS,eAAKpB,IAAL,CAAUkB,QAAQf,CAAR,EAAWkB,MAArB,EAA6BpB,KAA7B,CAAmC,uBAAuBgB,KAAKK,EAA/D,EAAmEpB,OAAnE,GAA6E,CAA7E,CAAb;AACA,kBAAIkB,MAAJ,EAAY;AACVA,uBAAOG,UAAP,GAAoB,IAAIpD,IAAJ,GAAWC,OAAX,EAApB;AACA8C,wBAAQf,CAAR,EAAWkB,MAAX,CAAkBG,IAAlB,CAAuB,UAACC,CAAD,EAAIC,CAAJ,EAAU;AAC/B,yBAAOA,EAAEH,UAAF,GAAeE,EAAEF,UAAxB;AACD,iBAFD;AAGAL,wBAAQf,CAAR,EAAWkB,MAAX,GAAoB,GAAGM,MAAH,CAAUT,QAAQf,CAAR,EAAWkB,MAArB,CAApB;AACA;AACD;AACF;AACD,2CAAqBO,UAArB,CAAgCV,OAAhC;AACD,WAfD,EAeG,CAfH;AAgBD;;AAED,YAAI,sBAAYW,UAAZ,EAAJ,EAA8B;AAC5B,gCAAYC,cAAZ,CAA2B,gBAA3B,EAA6C,EAACC,YAAYrC,OAAO5B,QAApB,EAA7C;AACD;AACD,YAAMe,UAAUpB,aAAaiC,OAAO5B,QAAP,CAAgB,CAAhB,CAAb,CAAhB;AACA,YAAMgB,SAASrB,aAAaiC,OAAO5B,QAAP,CAAgB4B,OAAO5B,QAAP,CAAgByB,MAAhB,GAAyB,CAAzC,CAAb,CAAf;;AAEA,YAAMyC,yBACDvC,KADC;AAEJZ,0BAFI;AAGJC,wBAHI;AAIJhB,oBAAU4B,OAAO5B,QAJb;AAKJS,mBAASmB,OAAOnB,OALZ;AAMJE,uBAAaiB,OAAOjB,WANhB;AAOJC,oBAAUgB,OAAOhB,QAPb;AAQJC,wBAAce,OAAOf,YARjB;AASJH,oBAAUkB,OAAOlB;AATb,UAAN;;AAYA,YAAIK,YAAYY,MAAMZ,OAAtB,EAA+B;AAC7BmD,oBAAUpD,KAAV,GAAkBqD,KAAKC,GAAL,CAASxC,OAAO5B,QAAP,CAAgByB,MAAzB,EAAiCE,MAAMb,KAAN,GAAcpB,kBAA/C,CAAlB;AACAwE,oBAAU/C,YAAV,GAAyB,uCAAoBkD,OAA7C,CAF6B,CAEyB;AACvD,SAHD,MAGO,IAAIrD,WAAWW,MAAMX,MAArB,EAA6B;AAClC;AACA,cAAMsD,aAAa1C,OAAO5B,QAAP,CAAgByB,MAAhB,GAAyBE,MAAM3B,QAAN,CAAeyB,MAA3D;;AAEAyC,oBAAUpD,KAAV,GAAkBqD,KAAKC,GAAL,CAASxC,OAAO5B,QAAP,CAAgByB,MAAzB,EAAiCE,MAAMb,KAAN,GAAcwD,UAA/C,CAAlB;AACAJ,oBAAU/C,YAAV,GAAyB,uCAAoBoD,IAA7C,CALkC,CAKiB;AACpD,SANM,MAMA;AACLL,oBAAUpD,KAAV,GAAkBqD,KAAKC,GAAL,CAASxC,OAAO5B,QAAP,CAAgByB,MAAzB,EAAiCE,MAAMb,KAAvC,CAAlB;AACAoD,oBAAU/C,YAAV,GAAyB,uCAAoBqD,MAA7C,CAFK,CAEgD;AACtD;;AAED,YAAI7C,MAAMd,YAAN,KAAuB,CAAvB,IAA4Be,OAAOf,YAAP,GAAsB,CAAtD,EAAyD;AACvD,cAAM4D,cAAc,8CAA2B7C,OAAO5B,QAAlC,EAA4C4B,OAAOf,YAAnD,EAAiE,oBAAU6D,OAAV,EAAjE,CAApB;AACA,cAAID,gBAAgB,CAAC,CAArB,EAAwB;AACtBP,sBAAUjD,QAAV,GAAqB,IAArB;AACD,WAFD,MAEO;AACLiD,sBAAUjD,QAAV,GAAqBW,OAAO5B,QAAP,CAAgByE,WAAhB,EAA6B5E,GAAlD;AACA,gBAAI4E,cAAcP,UAAUpD,KAA5B,EAAmC;AACjCoD,wBAAUpD,KAAV,GAAkBqD,KAAKC,GAAL,CAAUxC,OAAO5B,QAAP,CAAgByB,MAAhB,GAAyBgD,WAA1B,GAAyC/E,kBAAlD,EAAsEkC,OAAO5B,QAAP,CAAgByB,MAAtF,CAAlB;AACD;AACF;AACF;;AAED,eAAOyC,SAAP;;AAEF,WAAK,+BAAYS,kBAAjB;AACE,4BACKhD,KADL;AAEEb,iBAAOqD,KAAKC,GAAL,CAASzC,MAAM3B,QAAN,CAAeyB,MAAxB,EAAgCE,MAAMb,KAAN,GAAcpB,kBAA9C,CAFT;AAGEyB,wBAAc,uCAAoBkD;AAHpC;;AAMF,WAAK,+BAAYO,wBAAjB;AACE,4BACKjD,KADL;AAEEN,oBAAUM,MAAMN,QAAN,CAAewD,GAAf,CAAmBjD,OAAO4B,EAA1B,IAAgC7B,MAAMN,QAAN,CAAeyD,MAAf,CAAsBlD,OAAO4B,EAA7B,CAAhC,GAAmE7B,MAAMN,QAAN,CAAe0D,GAAf,CAAmBnD,OAAO4B,EAA1B;AAF/E;;AAKF,WAAK,+BAAYwB,mBAAjB;AACE,4BACKrD,KADL;AAEET,kBAAQU,OAAOhC,OAAP,CAAeC;AAFzB;;AAKF,WAAK,+BAAYoF,iBAAjB;AACE,4BACKtD,KADL;AAEET,kBAAQ;AAFV;;AAKF;AACE,eAAOS,KAAP;AA3HJ;AA6HD,G;;;;;kBAGY,IAAI7B,YAAJ,8B","file":"MessageStore.js","sourcesContent":["/*\n * Copyright (C) 2015-2016 Actor LLC. <https://actor.im>\n */\n\nimport Immutable from 'immutable';\nimport { ReduceStore } from 'flux/utils';\nimport Dispatcher from '../dispatcher/ActorAppDispatcher';\nimport { ActionTypes, MessageChangeReason } from '../constants/ActorAppConstants';\nimport ActorClient from '../utils/ActorClient';\nimport { getFirstUnreadMessageIndex } from '../utils/MessageUtils';\nimport UserStore from './UserStore';\nimport DialogStore from './DialogStore';\nimport MessageActionCreators from '../actions/MessageActionCreators';\nimport DialogActionCreators from '../actions/DialogActionCreators';\nimport linq from 'linq';\n\nconst MESSAGE_COUNT_STEP = 20;\n\nconst getMessageId = (message) => message ? message.rid : null;\n\nclass MessageStore extends ReduceStore {\n  getInitialState() {\n    return {\n      messages: [], // 所有的聊天记录存在这里\n      chatMessages: [], // 展示在聊天框中的聊天记录\n      historyMessages: [], // 聊天记录查找结果数据\n      historyQueryData: {\n        dateRange: [new Date().getTime(), new Date().getTime()],\n        filter: ''\n      }, // 聊天记录查询条件\n      historyLoaded: true, // 查询的历史数据是否加载完\n      overlay: [],\n      isLoaded: false,\n      receiveDate: 0,\n      readDate: 0,\n      readByMeDate: 0,\n      count: 0,\n      firstId: null,\n      lastId: null,\n      unreadId: null,\n      editId: null,\n      changeReason: MessageChangeReason.UNKNOWN,\n      selected: new Immutable.Set()\n    };\n  }\n\n  isAllRendered() {\n    const { messages, count } = this.getState();\n    return messages.length === count;\n  }\n\n  reduce (state, action) {\n    switch (action.type) {\n      case ActionTypes.BIND_DIALOG_PEER:\n        return this.getInitialState();\n\n\n      case ActionTypes.HISTROY_MESSAGES_CHANGED: \n        return {\n          ...state,\n          historyMessages: action.historyMessages\n        }\n      case ActionTypes.MESSAGES_CHANGED:\n        // 撤回消息删除处理\n        let message = null;\n        var revertMessage = linq.from(action.messages).where('$.content.content === \"customJson\" && $.content.operation === \"revert\"').toArray();\n        // var renderMessage = linq.from(action.messages).except(revertMessage, '$.rid').toArray();\n        for (var i = 0; i < revertMessage.length; i++) {\n          message = linq.from(action.messages).where((item) => {\n            return item.rid === JSON.parse(revertMessage[i].content.text).rid;\n          }).toArray()[0];\n          if (message) {\n            (function(msg) {\n              setTimeout(function () {\n                MessageActionCreators.deleteMessage(DialogStore.getCurrentPeer(), msg.rid);\n              }, 1);\n            })(message);\n          }\n        }\n\n        var message1 = state.messages.slice(-1)[0];\n        var message2 = action.messages.slice(-2)[0];\n        var message3 = action.messages.slice(-1)[0];\n        if (message1 && message2 && message2.rid === message1.rid && message3.content.content !== 'service') {\n          // 判断是否为手动发送数据\n          setTimeout(function () {\n            var peer = DialogStore.getCurrentPeer();\n            var dialogs = DialogStore.getDialogs();\n            for (var i = 0; i < dialogs.length; i++) {\n              var dialog = linq.from(dialogs[i].shorts).where('$.peer.peer.id ===' + peer.id).toArray()[0];\n              if (dialog) {\n                dialog.updateTime = new Date().getTime();\n                dialogs[i].shorts.sort((a, b) => {\n                  return b.updateTime - a.updateTime;\n                });\n                dialogs[i].shorts = [].concat(dialogs[i].shorts);\n                break;\n              }\n            }\n            DialogActionCreators.setDialogs(dialogs);\n          }, 1);\n        }\n        \n        if (ActorClient.isElectron()) {\n          ActorClient.sendToElectron('message-change', {currentMsg: action.messages});\n        }\n        const firstId = getMessageId(action.messages[0]);\n        const lastId = getMessageId(action.messages[action.messages.length - 1]);\n\n        const nextState = {\n          ...state,\n          firstId,\n          lastId,\n          messages: action.messages,\n          overlay: action.overlay,\n          receiveDate: action.receiveDate,\n          readDate: action.readDate,\n          readByMeDate: action.readByMeDate,\n          isLoaded: action.isLoaded\n        };\n\n        if (firstId !== state.firstId) {\n          nextState.count = Math.min(action.messages.length, state.count + MESSAGE_COUNT_STEP);\n          nextState.changeReason = MessageChangeReason.UNSHIFT; // 顶部插入（向上找聊天记录）\n        } else if (lastId !== state.lastId) {\n          // TODO: possible incorrect\n          const lengthDiff = action.messages.length - state.messages.length;\n\n          nextState.count = Math.min(action.messages.length, state.count + lengthDiff);\n          nextState.changeReason = MessageChangeReason.PUSH; // 底部插入（聊天的过程）\n        } else {\n          nextState.count = Math.min(action.messages.length, state.count);\n          nextState.changeReason = MessageChangeReason.UPDATE; // 中间更新（删除记录等）\n        }\n\n        if (state.readByMeDate === 0 && action.readByMeDate > 0) {\n          const unreadIndex = getFirstUnreadMessageIndex(action.messages, action.readByMeDate, UserStore.getMyId());\n          if (unreadIndex === -1) {\n            nextState.unreadId = null;\n          } else {\n            nextState.unreadId = action.messages[unreadIndex].rid;\n            if (unreadIndex > nextState.count) {\n              nextState.count = Math.min((action.messages.length - unreadIndex) + MESSAGE_COUNT_STEP, action.messages.length);\n            }\n          }\n        }\n\n        return nextState;\n\n      case ActionTypes.MESSAGES_LOAD_MORE:\n        return {\n          ...state,\n          count: Math.min(state.messages.length, state.count + MESSAGE_COUNT_STEP),\n          changeReason: MessageChangeReason.UNSHIFT\n        };\n\n      case ActionTypes.MESSAGES_TOGGLE_SELECTED:\n        return {\n          ...state,\n          selected: state.selected.has(action.id) ? state.selected.remove(action.id) : state.selected.add(action.id)\n        };\n\n      case ActionTypes.MESSAGES_EDIT_START:\n        return {\n          ...state,\n          editId: action.message.rid\n        };\n\n      case ActionTypes.MESSAGES_EDIT_END:\n        return {\n          ...state,\n          editId: null\n        };\n\n      default:\n        return state;\n    }\n  }\n}\n\nexport default new MessageStore(Dispatcher);\n"]}