{"version":3,"sources":["../../../../src/components/common/dropdown/MessageActions.react.js"],"names":["MessageActions","props","handleDocumentClick","event","dropdown","refs","dropdownRect","getBoundingClientRect","coords","x","pageX","clientX","y","pageY","clientY","preventDefault","handleDropdownClose","hideMessageDropdown","handleDelete","peer","message","deleteMessage","rid","handleRepeat","sendType","type","key","content","peer1","id","peer2","console","log","dataURItoBlob","handleReply","info","getUser","sender","replyText","nick","name","pasteText","handleQuote","text","handleRevert","profile","sendJson","JSON","stringify","data","uid","dataType","operation","shouldComponentUpdate","bind","componentDidMount","listeners","capture","document","componentWillUnmount","forEach","listener","remove","dataURI","byteString","atob","split","mimeString","ab","ArrayBuffer","length","ia","Uint8Array","i","charCodeAt","Blob","render","targetRect","intl","context","isThisMyMessage","getMyId","dropdownStyles","top","left","dropdownMenuStyles","minWidth","right","messages","Date","getTime","parseFloat","sortKey","TEXT","propTypes","object","isRequired","contextTypes"],"mappings":"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","file":"MessageActions.react.js","sourcesContent":["/*\n * Copyright (C) 2015-2016 Actor LLC. <https://actor.im>\n */\n\nimport React, { Component, PropTypes } from 'react';\nimport EventListener from 'fbjs/lib/EventListener';\nimport { findDOMNode } from 'react-dom';\nimport { shouldComponentUpdate } from 'react-addons-pure-render-mixin';\n\nimport isInside from '../../../utils/isInside';\nimport { quoteMessage } from '../../../utils/MessageUtils';\nimport ActorClient from '../../../utils/ActorClient';\n\nimport { MessageContentTypes } from '../../../constants/ActorAppConstants';\n\nimport ProfileStore from '../../../stores/ProfileStore';\n\nimport MessageActionCreators from '../../../actions/MessageActionCreators';\nimport ComposeActionCreators from '../../../actions/ComposeActionCreators';\nimport DropdownActionCreators from '../../../actions/DropdownActionCreators';\n\nimport UserStore from '../../../stores/UserStore';\n\nclass MessageActions extends Component {\n  static propTypes = {\n    peer: PropTypes.object.isRequired,\n    message: PropTypes.object.isRequired,\n    targetRect: PropTypes.object.isRequired,\n    profile: PropTypes.object.isRequired\n  };\n\n  static contextTypes = {\n    intl: PropTypes.object\n  };\n\n  constructor(props) {\n    super(props);\n\n    this.shouldComponentUpdate = shouldComponentUpdate.bind(this);\n  }\n\n  componentDidMount() {\n    this.listeners = [\n      EventListener.capture(document, 'click', this.handleDocumentClick),\n      EventListener.capture(document, 'scroll', this.handleDropdownClose)\n    ];\n  }\n\n  componentWillUnmount() {\n    this.listeners.forEach((listener) => {\n      listener.remove();\n    });\n\n    this.listeners = null;\n  }\n\n  handleDocumentClick = (event) => {\n    const dropdown = findDOMNode(this.refs.dropdown);\n    const dropdownRect = dropdown.getBoundingClientRect();\n    const coords = {\n      x: event.pageX || event.clientX,\n      y: event.pageY || event.clientY\n    };\n\n    if (!isInside(coords, dropdownRect)) {\n      event.preventDefault();\n      this.handleDropdownClose();\n    }\n  };\n\n\n  handleDropdownClose = () => DropdownActionCreators.hideMessageDropdown();\n\n  handleDelete = () => {\n    const { peer, message } = this.props;\n    MessageActionCreators.deleteMessage(peer, message.rid);\n    this.handleDropdownClose();\n  };\n\n  handleRepeat= ()=> {\n    // 消息转发\n    const { message } = this.props;\n    const sendType = {\n      'text': {type: 'sendTextMessage', key: 'text'},\n      'photo': {type: 'sendPhotoMessage', key: 'preview'}\n    };\n    const type = sendType[message.content.content].type;\n    const key = sendType[message.content.content].key;\n    var peer1 = {\n      id: 130508843,\n      key: 'g130508843',\n      type: 'group'\n    };\n    var peer2 = {\n      id: 182777372,\n      key: 'u182777372',\n      type: 'user'\n    }\n    console.log('preview', message.content[key]);\n    // ActorClient[type](peer1, message.content[key]);\n    ActorClient[type](peer2, this.dataURItoBlob(message.content[key]));\n    // ActorClient.sendPhotoMessage\n    \n  }\n  \n  dataURItoBlob(dataURI) {  \n    var byteString = atob(dataURI.split(',')[1]);  \n    var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];  \n    var ab = new ArrayBuffer(byteString.length);  \n    var ia = new Uint8Array(ab);  \n    for (var i = 0; i < byteString.length; i++) {  \n        ia[i] = byteString.charCodeAt(i);  \n    }  \n    return new Blob([ab], {type: mimeString});  \n}  \n\n  handleReply = () => {\n    const { message } = this.props;\n    const info = UserStore.getUser(message.sender.peer.id);\n    const replyText = info.nick ? `@${info.nick}: ` : `${info.name}: `;\n    ComposeActionCreators.pasteText(replyText);\n    this.handleDropdownClose();\n  };\n\n  handleQuote = () => {\n    const { message } = this.props;\n    ComposeActionCreators.pasteText(quoteMessage(message.content.text) + '\\n');\n    this.handleDropdownClose();\n  };\n\n  handleRevert = () => {\n    const { message, peer, profile } = this.props;\n    ActorClient.sendJson(peer, \n      JSON.stringify({\n        data:{\n          text:`\"${profile.name}\"撤回了一条消息`,\n          rid: message.rid,\n          uid: message.sender.peer.id\n        },\n        dataType: 'revert',\n        operation:'revert'\n      })\n    );\n  }\n\n  render() {\n    const { message, targetRect, profile } = this.props;\n    console.log('profile12312312313123', profile,  message.sender);\n    const { intl } = this.context;\n\n    const isThisMyMessage = UserStore.getMyId() === message.sender.peer.id;\n\n    const dropdownStyles = {\n      top: targetRect.top,\n      left: targetRect.left\n    };\n\n    const dropdownMenuStyles = {\n      minWidth: 120,\n      right: 2,\n      top: -4\n    };\n\n    return (\n      <div className=\"dropdown dropdown--opened dropdown--small\" style={dropdownStyles}>\n        <ul className=\"dropdown__menu dropdown__menu--right\" ref=\"dropdown\" style={dropdownMenuStyles}>\n          <li className=\"dropdown__menu__item hide\">\n            <i className=\"icon material-icons\">star_rate</i> {intl.messages['message.pin']}\n          </li>\n          {/* <li className=\"dropdown__menu__item\" onClick={this.handleRepeat}>\n            <i className=\"icon material-icons\">repeat</i> {intl.messages['message.repeat']}\n          </li> */}\n          {\n            message.content.content !== 'customJson' && message.content.operation !== 'revert' && message.sender.peer.id === profile.id && ((new Date().getTime() - parseFloat(message.sortKey)) < 15 * 60 * 1000)\n            ? <li className=\"dropdown__menu__item\" onClick={this.handleRevert}>\n                <i className=\"icon material-icons\">redo</i> {intl.messages['message.redo']}\n              </li>\n            : null\n          }\n          {\n            !isThisMyMessage\n              ? <li className=\"dropdown__menu__item\" onClick={this.handleReply}>\n                  <i className=\"icon material-icons\">reply</i> {intl.messages['message.reply']}\n                </li>\n              : null\n          }\n          {\n            message.content.content === MessageContentTypes.TEXT\n              ? <li className=\"dropdown__menu__item\" onClick={this.handleQuote}>\n                  <i className=\"icon material-icons\">format_quote</i> {intl.messages['message.quote']}\n                </li>\n              : null\n          }\n          <li className=\"dropdown__menu__item hide\">\n            <i className=\"icon material-icons\">forward</i> {intl.messages['message.forward']}\n          </li>\n          <li className=\"dropdown__menu__item\" onClick={this.handleDelete}>\n            <i className=\"icon material-icons\">delete</i> {intl.messages['message.delete']}\n          </li>\n        </ul>\n      </div>\n    );\n  }\n}\n\nexport default MessageActions;\n"]}