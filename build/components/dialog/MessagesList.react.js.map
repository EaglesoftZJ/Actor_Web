{"version":3,"sources":["../../../src/components/dialog/MessagesList.react.js"],"names":["MessagesList","getStores","calculateState","isShow","getShowState","record","getCurrentRecord","node","getCurrentNode","ringDomId","getRingDomId","props","context","console","log","state","showScrollToBottom","updateRecord","dimensions","isLoading","onResize","bind","onScroll","handleScrollToBottom","shouldComponentUpdate","nextProps","nextState","peer","messages","isMember","componentWillMount","dialog","delegate","components","MessageItem","message","Welcome","welcome","componentDidMount","restoreScroll","componentWillUnmount","cleanListeners","componentWillReceiveProps","equals","updateDimensions","refs","scroller","getDimensions","componentDidUpdate","prevProps","prevState","setListeners","uid","unreadId","unread","scrollToNode","changeReason","PUSH","_isLastMessageMine","scrollToBottom","UNSHIFT","nextDimensions","scrollTo","scrollHeight","listeners","listen","document","popoverHide","forEach","listener","remove","hide","setRecord","scrollTop","onLoadMore","offsetHeight","setState","ratio","handleScrollToMessage","span","getElementById","parents","get","setTimeout","setRingDomId","handleTableClick","event","nativeEvent","stopImmediatePropagation","renderHeader","isLoaded","length","renderMessages","overlay","count","selected","receiveDate","readDate","editId","result","index","rid","push","overlayItem","dateDivider","useShort","has","onEdit","onSelect","sortKey","renderScrollToBottomButton","renderScrollToMessage","renderInfo","tr","map","item","userName","time","render","addLeft","outer","clientWidth","addTop","height","contextTypes","object","isRequired","propTypes","number","shape","array","bool","string","oneOf","UNKNOWN","UPDATE","func","create","withProps","withContext"],"mappings":"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","file":"MessagesList.react.js","sourcesContent":["/*\n * Copyright (C) 2015-2016 Actor LLC. <https://actor.im>\n */\n\nimport { isFunction, throttle } from 'lodash';\n\nimport React, { Component, PropTypes } from 'react';\n\nimport { FormattedMessage } from 'react-intl';\nimport { Container } from 'flux/utils';\nimport EventListener from 'fbjs/lib/EventListener';\nimport { MessageChangeReason } from '../../constants/ActorAppConstants';\n\nimport PeerUtils from '../../utils/PeerUtils';\nimport { getMessageState, isLastMessageMine } from '../../utils/MessageUtils';\nimport Scroller from '../common/Scroller.react';\n\nimport DocumentRecordStore from '../../stores/DocumentRecordStore.js';\nimport RingStore from '../../stores/RingStore.js';\n\nimport DocumentRecordCreators from '../../actions/DocumentRecordCreators';\nimport RingActionCreators from '../../actions/RingActionCreators'\n\nimport DefaultMessageItem from './messages/MessageItem.react';\nimport DefaultWelcome from './messages/Welcome.react';\nimport Loading from './messages/Loading.react';\nimport Popover from '../common/Popover.react';\nimport $ from 'jquery';\nimport { lightbox } from '../../utils/ImageUtils';\n\nclass MessagesList extends Component {\n    static getStores() {\n        return [DocumentRecordStore, RingStore];\n    }\n  static contextTypes = {\n    delegate: PropTypes.object.isRequired\n  };\n\n  static propTypes = {\n    uid: PropTypes.number.isRequired,\n    peer: PropTypes.object.isRequired,\n    messages: PropTypes.shape({\n      messages: PropTypes.array.isRequired,\n      overlay: PropTypes.array.isRequired,\n      count: PropTypes.number.isRequired,\n      isLoaded: PropTypes.bool.isRequired,\n      receiveDate: PropTypes.number.isRequired,\n      readDate: PropTypes.number.isRequired,\n      editId: PropTypes.string,\n      unreadId: PropTypes.string,\n      selected: PropTypes.object.isRequired,\n      changeReason: PropTypes.oneOf([\n        MessageChangeReason.UNKNOWN,\n        MessageChangeReason.PUSH,\n        MessageChangeReason.UNSHIFT,\n        MessageChangeReason.UPDATE\n      ]).isRequired\n    }).isRequired,\n    isMember: PropTypes.bool.isRequired,\n    onSelect: PropTypes.func.isRequired,\n    onLoadMore: PropTypes.func.isRequired,\n    onEdit: PropTypes.func.isRequired\n  };\n\n  static calculateState() {\n    return {\n      isShow: DocumentRecordStore.getShowState(),\n      record: DocumentRecordStore.getCurrentRecord(),\n      node: DocumentRecordStore.getCurrentNode(),\n      ringDomId: RingStore.getRingDomId()\n    }\n  }\n\n  constructor(props, context) {\n    super(props, context);\n\n    console.log('messageList', props, context);\n\n    this.state = {\n      showScrollToBottom: false,\n      updateRecord: false\n    };\n\n    this.dimensions = null;\n    this.isLoading = false;\n\n    this.onResize = this.onResize.bind(this);\n    this.onScroll = throttle(this.onScroll.bind(this), 300);\n    this.handleScrollToBottom = this.handleScrollToBottom.bind(this);\n  }\n\n  shouldComponentUpdate(nextProps, nextState) {\n    return nextProps.peer !== this.props.peer ||\n           nextProps.messages !== this.props.messages ||\n           nextProps.isMember !== this.props.isMember ||\n           nextState.showScrollToBottom !== this.state.showScrollToBottom\n  }\n\n  componentWillMount() {\n    // 渲染前\n      const { dialog } = this.context.delegate.components;\n      console.log('delegate components', this.context.delegate.components);\n    if (dialog && dialog.messages) {\n      this.components = {\n        MessageItem: isFunction(dialog.messages.message) ? dialog.messages.message : DefaultMessageItem,\n        Welcome: isFunction(dialog.messages.welcome) ? dialog.messages.welcome : DefaultWelcome\n      };\n    } else {\n    this.components = {\n        MessageItem: DefaultMessageItem,\n        Welcome: DefaultWelcome\n        };\n    }\n  }\n\n  componentDidMount() {\n    this.restoreScroll();\n    // this.setListeners();\n  }\n\n  componentWillUnmount() {\n    this.cleanListeners();\n  }\n\n  componentWillReceiveProps(nextProps) {\n      const { messages: { messages } } = this.props;\n        // console.log('message change', messages.length , nextProps.messages.messages.length, messages.slice(-1)[0] && messages.slice(-1)[0].rid, nextProps.messages.messages.slice(-2)[0] && nextProps.messages.messages.slice(-2)[0].rid)\n    //   if (messages.length +  1 === nextProps.messages.messages.length && \n    //     messages.slice(-1)[0].rid === nextProps.messages.messages.slice(-2)[0].rid &&\n    //     nextProps.messages.messages.slice(-1)[0].content.content === 'text') {\n    //         // 新的消息\n    //         console.log('新消息新消息');\n    //         setTimeout(function() {\n    //             RingActionCreators.setNew(true);\n    //         }, 1);\n    //   }\n    if (!PeerUtils.equals(nextProps.peer, this.props.peer)) {\n      this.dimensions = null;\n      this.isLoading = false;\n    } else {\n      this.updateDimensions(this.refs.scroller.getDimensions());\n    }\n  }\n\n    // componentWillUpdate(nextProps, nextState) {\n    //     const { message } = this.state;\n    //     if (nextState.message != message) {\n    //         this.setState({updateRecord: true});\n    //     }\n    // }\n  \n  componentDidUpdate(prevProps, prevState) {\n\n    const { isShow, record } = this.state;\n    console.log('更新更新', prevState.isShow, isShow, prevState, this.state, prevProps, this.props);\n    if (!prevState.isShow && isShow) {\n        this.setListeners();\n    }\n    if (prevState.showScrollToBottom !== this.state.showScrollToBottom || prevState.record !== record || prevState.isShow !== isShow) {\n      return;\n    }\n    const { dimensions, refs: { scroller }, props: { uid, messages } } = this;\n    if (prevProps.messages.messages !== messages.messages) {\n        console.log('message发生改变了！！！');\n        // lightbox.load({\n        //     boxId: false,\n        //     dimensions: true,\n        //     captions: true,\n        //     prevImg: false,\n        //     nextImg: false,\n        //     hideCloseBtn: false,\n        //     closeOnClick: true,\n        //     animElCount: 4,\n        //     preload: true,\n        //     carousel: false,\n        //     animation: false,\n        //     nextOnClick: true,\n        //     responsive: true,\n        //     maxImgSize: 0.8,\n        //     // callbacks\n        //     onopen: function (image) {\n        //         // your code goes here\n        //         console.log('onopen', image)\n        //     },\n        //     onclose: function (image) {\n        //         // your code goes here\n        //         console.log('onclose', image)\n        //     },\n        //     onload: function (event) {\n        //         // your code goes here\n        //         console.log('onload', event)\n        //     },\n        //     onresize: function (image) {\n        //         // your code goes here\n        //         console.log('onresize', image)\n        //     },\n        //     onloaderror: function (event) {\n        //         // your code goes here\n        //         console.log('onloaderror', event)\n        //         // just display next or prev picture on error\n        //         // if (event._happenedWhile === 'prev')\n        //         //     lightbox.prev()\n        //         // else\n        //         //     lightbox.next()\n        //     },\n        //     onimageclick: function (image) {\n        //         // your code goes here\n        //         console.log('Image clicked!', image)\n        //     }\n        // });\n    }\n    if (messages.unreadId && messages.unreadId !== prevProps.messages.unreadId) {\n      if (this.refs.unread) {\n        this.refs.scroller.scrollToNode(this.refs.unread);\n      }\n    } else if (messages.changeReason === MessageChangeReason.PUSH) {\n      const _isLastMessageMine = isLastMessageMine(uid, messages);\n      if (!dimensions || _isLastMessageMine) {\n        this.scrollToBottom();\n      }\n    } else if (messages.changeReason === MessageChangeReason.UNSHIFT) {\n      this.isLoading = false;\n      if (dimensions) {\n        const nextDimensions = scroller.getDimensions();\n        // Restore scroll\n        scroller.scrollTo(nextDimensions.scrollHeight - dimensions.scrollHeight);\n      } else {\n        this.scrollToBottom();\n      }\n    } else {\n      this.restoreScroll();\n    }\n  }\n\n  setListeners() {\n    this.cleanListeners();\n    this.listeners = [\n      // EventListener.listen(document, 'keydown', this.handleKeyDown),\n      EventListener.listen(document, 'click', this.popoverHide.bind(this))\n    ];\n  }\n\n  cleanListeners() {\n    if (this.listeners) {\n      this.listeners.forEach((listener) => listener.remove());\n      this.listeners = null;\n    }\n  }\n\n  popoverHide() {\n    DocumentRecordCreators.hide();\n    DocumentRecordCreators.setRecord([]);\n    this.cleanListeners();\n  }\n\n  onScroll() {\n      const { isShow } = this.state;\n    const dimensions = this.refs.scroller.getDimensions();\n    this.updateDimensions(dimensions);\n    isShow && this.popoverHide();\n    if (!this.isLoading && dimensions.scrollTop < 100) {\n      this.isLoading = true;\n      this.props.onLoadMore();\n    }\n\n    const showScrollToBottom = dimensions.scrollTop < dimensions.scrollHeight - (2 * dimensions.offsetHeight);\n\n    if (showScrollToBottom !== this.state.showScrollToBottom) {\n      this.setState({ showScrollToBottom });\n    }\n  }\n\n  onResize() {\n    const { dimensions, refs: { scroller } } = this;\n    if (dimensions) {\n      // Fix scroll\n      const ratio = dimensions.scrollTop / dimensions.scrollHeight;\n      const nextDimensions = scroller.getDimensions();\n      scroller.scrollTo(ratio * nextDimensions.scrollHeight);\n      this.dimensions = nextDimensions;\n    } else {\n      scroller.scrollToBottom();\n    }\n  }\n\n  handleScrollToBottom() {\n    this.refs.scroller.scrollToBottom();\n  }\n\n  handleScrollToMessage() {\n      const { ringDomId } = this.state;\n      var span = document.getElementById(ringDomId);\n      if (ringDomId && span) {\n          console.log('new text', $(span).parents('.message').get(0));\n          setTimeout((() => {\n            this.refs.scroller.scrollToNode($(span).parents('.message').get(0));\n          }), 100);\n        \n      }\n        RingActionCreators.setRingDomId('');\n    \n       \n  }\n\n  handleTableClick(event) {\n    event.nativeEvent.stopImmediatePropagation();\n  }\n\n  renderHeader() {\n    const { peer, isMember, messages } = this.props;\n\n    if (!isMember) {\n      return null;\n    }\n\n    if (messages.isLoaded) {\n      const { Welcome } = this.components;\n      return <Welcome peer={peer} key=\"header\" />;\n    }\n\n    if (!messages.messages.length) {\n      return null;\n    }\n\n    return <Loading key=\"header\" />;\n  }\n\n  renderMessages() {\n    const { uid, peer, messages: { messages, overlay, count, selected, receiveDate, readDate, editId, unreadId } } = this.props;\n    const { MessageItem } = this.components;\n\n    const result = [];\n    for (let index = messages.length - count; index < messages.length; index++) {\n      const message = messages[index];\n      if (message.rid === unreadId) {\n        result.push(\n          <div className=\"unread-divider\" ref=\"unread\" key=\"unread\">\n            <div className=\"text\">\n              <i className=\"material-icons\">expand_more</i>\n              <FormattedMessage id=\"message.unread\"/>\n              <i className=\"material-icons\">expand_more</i>\n            </div>\n          </div>\n        );\n      }\n\n      const overlayItem = overlay[index];\n      if (overlayItem && overlayItem.dateDivider) {\n        result.push(\n          <div className=\"date-divider\" key={overlayItem.dateDivider}>\n            {overlayItem.dateDivider}\n          </div>\n        );\n      }\n\n      result.push(\n        <MessageItem\n          peer={peer}\n          message={message}\n          state={getMessageState(message, uid, receiveDate, readDate)}\n          isShort={overlayItem.useShort}\n          isSelected={selected.has(message.rid)}\n          isEditing={editId === message.rid}\n          onEdit={this.props.onEdit}\n          onSelect={this.props.onSelect}\n          key={message.sortKey}\n        />\n      );\n    }\n\n    return result;\n  }\n\n  renderScrollToBottomButton() {\n    const { showScrollToBottom } = this.state;\n    if (!showScrollToBottom) {\n      return null;\n    }\n\n    return (\n        <div className=\"chat__scroll-to-bottom\" onClick={this.handleScrollToBottom}>\n            <i className=\"material-icons\">keyboard_arrow_down</i>\n        </div>\n    );\n  }\n  renderScrollToMessage() {\n      console.log('renderScrollToMessage==================')\n    const { ringDomId } = this.state;\n    console.log('重新渲染数据', ringDomId);\n    if (!ringDomId) {\n        return null; \n    }\n      return (\n        <div className=\"chat__scroll-to-bottom chat__scroll-to-message\" onClick={this.handleScrollToMessage.bind(this)}>\n            <i>@</i>    \n        </div>\n      )\n  }\n\n  renderInfo() {\n    // 渲染下载详情\n    const { record } = this.state;\n    if (!record || record.length === 0) {\n        return null;\n    }\n    var tr = record.map((item, index) => {\n       return(\n            <tr key={ index }>\n                <td>{ item.userName }</td>\n                <td>于{ item.time }下载</td>\n            </tr>\n       );\n    })\n    return (\n        <table className=\"message_record_table\" onClick={this.handleTableClick}>\n            <tbody>\n            { tr } \n           </tbody>\n        </table>\n    )\n  }\n\n  render() {\n      const { node, isShow } = this.state;\n      var addLeft = this.refs.outer ? 305 - this.refs.outer.clientWidth : 0;\n      var addTop = ($(node).height() - 22) / 2;\n      console.log('偏移量', addLeft, addTop);\n      console.log('node isShow', node, isShow);\n    return (\n      <div className=\"chat__container\" ref=\"outer\">\n        <Popover node={node} isShow={isShow} container={this.refs.outer} addLeft={addLeft} addTop={addTop} maxHeight={ 300 } emptyMsg=\"message.documentRecord\">\n            { this.renderInfo() }\n        </Popover>\n        <Scroller\n          className=\"chat__messages\"\n          ref=\"scroller\"\n          onScroll={this.onScroll}\n          onResize={this.onResize}\n        >\n          {this.renderHeader()}\n          {this.renderMessages()}\n        </Scroller>\n        <div className=\"chat__scroll-to-box\">\n            {this.renderScrollToMessage()}\n            {this.renderScrollToBottomButton()}\n        </div>\n      </div>\n    )\n  }\n\n  scrollToBottom() {\n    this.dimensions = null;\n    this.refs.scroller.scrollToBottom();\n  }\n\n  updateDimensions(dimensions) {\n    if (dimensions.scrollHeight === dimensions.scrollTop + dimensions.offsetHeight) {\n      // Lock scroll to bottom\n      this.dimensions = null;\n    } else {\n      this.dimensions = dimensions;\n    }\n  }\n\n  restoreScroll() {\n    const { dimensions, refs: { scroller } } = this;\n\n    if (dimensions) {\n      scroller.scrollTo(dimensions.scrollTop);\n    } else {\n      scroller.scrollToBottom();\n    }\n  }\n}\n\nexport default Container.create(MessagesList, {withProps: true, withContext: true});\n;\n"]}