{"version":3,"sources":["../../src/utils/MessageUtils.js"],"names":["getMessageState","prepareTextMessage","quoteMessage","isLastMessageMine","getFirstUnreadMessageIndex","findLastEditableMessage","isMessageSender","message","uid","sender","peer","id","receiveDate","readDate","UNKNOWN","isOut","state","SENT","sortDate","READ","RECEIVED","text","change_replace_mode","replace_colons","trim","split","map","line","join","messages","lastMessage","length","index","i","MAX_EDIT_TIME","now","Date","minDate","console","debug","content"],"mappings":"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","file":"MessageUtils.js","sourcesContent":["import { emoji } from './EmojiUtils';\nimport { MessageStates } from '../constants/ActorAppConstants';\n\nfunction isMessageSender(message, uid) {\n  return uid === message.sender.peer.id;\n}\n\nexport function getMessageState(message, uid, receiveDate, readDate) {\n  if (message.sender.peer.id !== uid) {\n    return MessageStates.UNKNOWN;\n  }\n\n  if (message.isOut && message.state === MessageStates.SENT) {\n    if (message.sortDate <= readDate) {\n      return MessageStates.READ;\n    }\n\n    if (message.sortDate <= receiveDate) {\n      return MessageStates.RECEIVED;\n    }\n  }\n\n  return message.state;\n}\n\nexport function prepareTextMessage(text) {\n  emoji.change_replace_mode('unified');\n  return emoji.replace_colons(text);\n}\n\nexport function quoteMessage(text) {\n  return text\n    .trim()\n    .split('\\n')\n    .map((line) => `> ${line}`)\n    .join('\\n');\n}\n\nexport function isLastMessageMine(uid, { messages }) {\n  const lastMessage = messages[messages.length - 1];\n  return lastMessage && isMessageSender(lastMessage, uid);\n}\n\nexport function getFirstUnreadMessageIndex(messages, readDate, uid) {\n  if (readDate === 0 || !messages.length) {\n    return -1;\n  }\n\n  let index = -1;\n  for (let i = messages.length - 1; i >= 0; i--) {\n    const message = messages[i];\n    if (message.sortDate <= readDate || isMessageSender(message, uid)) {\n      return index;\n    }\n\n    index = i;\n  }\n\n  // maybe unreachable\n  return index;\n}\n\nconst MAX_EDIT_TIME = 5 * 60;\nexport function findLastEditableMessage(messages, uid) {\n  const now = Date.now() / 1000;\n  const minDate = now - MAX_EDIT_TIME;\n\n  console.debug('Check editable message', { minDate });\n  for (let i = messages.length - 1; i >= 0; i--) {\n    const message = messages[i];\n    if (message.sortDate < minDate) {\n      console.debug('Message not editable due sortDate', { message });\n      return null;\n    }\n\n    if (isMessageSender(message, uid)) {\n      if (message.content.content === 'text') {\n        console.debug('Found editable message', { message });\n        return message;\n      }\n\n      console.debug('Last my message is not text', { message });\n\n      return null;\n    }\n  }\n\n  return null;\n}\n"]}